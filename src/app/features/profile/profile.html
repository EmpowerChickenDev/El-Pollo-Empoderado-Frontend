<div class="profile-container">
  <div class="profile-header">
    <h1>Mi Cuenta</h1>
    <p class="profile-subtitle">Gestiona tu información y preferencias</p>
  </div>

  <!-- Mensajes de éxito/error globales -->
  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
  </div>

  <!-- Skeleton Screen -->
  <div *ngIf="isLoading" class="profile-content">
    <div class="profile-avatar-section">
      <div class="skeleton skeleton-avatar"></div>
      <div class="skeleton skeleton-text skeleton-username"></div>
      <div class="skeleton skeleton-text skeleton-email"></div>
    </div>

    <div class="profile-info-grid">
      <div class="profile-card">
        <div class="skeleton skeleton-icon"></div>
        <div class="skeleton skeleton-text skeleton-label"></div>
        <div class="skeleton skeleton-text skeleton-value"></div>
      </div>

      <div class="profile-card">
        <div class="skeleton skeleton-icon"></div>
        <div class="skeleton skeleton-text skeleton-label"></div>
        <div class="skeleton skeleton-text skeleton-value"></div>
      </div>

      <div class="profile-card">
        <div class="skeleton skeleton-icon"></div>
        <div class="skeleton skeleton-text skeleton-label"></div>
        <div class="skeleton skeleton-text skeleton-value"></div>
      </div>
    </div>

    <div class="quick-actions">
      <div class="skeleton skeleton-button"></div>
      <div class="skeleton skeleton-button"></div>
      <div class="skeleton skeleton-button"></div>
    </div>
  </div>

  <!-- Contenido Real -->
  <div *ngIf="!isLoading && userProfile" class="profile-content">
    <!-- Avatar -->
    <div class="profile-avatar-section">
      <div class="profile-avatar">
        <span>{{ userProfile.firstName.charAt(0).toUpperCase() }}</span>
      </div>
      <h2 class="profile-username">{{ userProfile.firstName }} {{ userProfile.lastName }}</h2>
      <p class="profile-email">{{ userProfile.email }}</p>
      <span class="member-badge">Cliente desde {{ userProfile.createdAt | date: 'MMMM yyyy' }}</span>
    </div>

    <!-- Info Cards -->
    <div class="profile-info-grid">
      <div class="profile-card">
        <div class="card-icon pedidos-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M3 3h18v18H3z" />
            <path d="M8 7h8M8 11h8M8 15h5" />
          </svg>
        </div>
        <p class="card-label">Total de Pedidos</p>
        <p class="value-large">0</p>
        <span class="value-subtitle">pedidos realizados</span>
      </div>

      <div class="profile-card">
        <div class="card-icon favoritos-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path
              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
          </svg>
        </div>
        <p class="card-label">Platos Favoritos</p>
        <p class="value-large">0</p>
        <span class="value-subtitle">productos guardados</span>
      </div>

      <div class="profile-card">
        <div class="card-icon puntos-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <polygon
              points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
          </svg>
        </div>
        <p class="card-label">Puntos Acumulados</p>
        <p class="value-large">0</p>
        <span class="value-subtitle">pts disponibles</span>
      </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="quick-actions">
      <h3>Acciones Rápidas</h3>
      <div class="actions-grid">
        <button class="action-btn" routerLink="/pedidos">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1" />
            <circle cx="20" cy="21" r="1" />
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
          </svg>
          Ver Mis Pedidos
        </button>

        <button class="action-btn" routerLink="/menu">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M3 3h18v18H3z" />
            <path d="M12 8v8M8 12h8" />
          </svg>
          Hacer Nuevo Pedido
        </button>

        <button class="action-btn" routerLink="/locales">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
            <circle cx="12" cy="10" r="3" />
          </svg>
          Encontrar Local
        </button>
      </div>
    </div>

    <!-- SECCIÓN DE EDICIÓN DE PERFIL -->
    <div class="edit-section">
      <div class="edit-header">
        <h3>Información Personal</h3>
        <button *ngIf="!isEditingProfile" class="btn-edit" (click)="enableEditProfile()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
          Editar
        </button>
      </div>

      <div *ngIf="profileError" class="error-message-inline">
        {{ profileError }}
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">
        <div class="form-grid">
          <div class="form-group">
            <label for="username">Nombre de usuario</label>
            <input type="text" id="username" formControlName="username" [class.input-error]="usernameInvalid"
              [readonly]="!isEditingProfile">
            <span *ngIf="usernameInvalid" class="field-error">
              El nombre debe tener al menos 3 caracteres
            </span>
          </div>

          <div class="form-group">
            <label for="email">Correo electrónico</label>
            <input type="email" id="email" formControlName="email" [class.input-error]="emailInvalid"
              [readonly]="!isEditingProfile">
            <span *ngIf="emailInvalid" class="field-error">
              Ingresa un correo válido
            </span>
          </div>
        </div>

        <div *ngIf="isEditingProfile" class="form-actions">
          <button type="button" class="btn-cancel" (click)="cancelEditProfile()" [disabled]="isSavingProfile">
            Cancelar
          </button>
          <button type="submit" class="btn-save" [disabled]="isSavingProfile || profileForm.invalid">
            {{ isSavingProfile ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </form>
    </div>

    <!-- SECCIÓN DE CAMBIO DE CONTRASEÑA -->
    <div class="edit-section">
      <div class="edit-header">
        <h3>Seguridad</h3>
        <button *ngIf="!isEditingPassword" class="btn-edit" (click)="enableChangePassword()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
          </svg>
          Cambiar Contraseña
        </button>
      </div>

      <div *ngIf="isEditingPassword">
        <div *ngIf="passwordError" class="error-message-inline">
          {{ passwordError }}
        </div>

        <form [formGroup]="passwordForm" (ngSubmit)="savePassword()">
          <div class="form-group">
            <label for="currentPassword">Contraseña actual</label>
            <input type="password" id="currentPassword" formControlName="currentPassword"
              [class.input-error]="currentPasswordInvalid" placeholder="Ingresa tu contraseña actual">
            <span *ngIf="currentPasswordInvalid" class="field-error">
              La contraseña debe tener al menos 6 caracteres
            </span>
          </div>

          <div class="form-group">
            <label for="newPassword">Nueva contraseña</label>
            <input type="password" id="newPassword" formControlName="newPassword"
              [class.input-error]="newPasswordInvalid" placeholder="Ingresa tu nueva contraseña">
            <span *ngIf="newPasswordInvalid" class="field-error">
              La contraseña debe tener al menos 6 caracteres
            </span>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmar nueva contraseña</label>
            <input type="password" id="confirmPassword" formControlName="confirmPassword"
              [class.input-error]="confirmPasswordInvalid" placeholder="Confirma tu nueva contraseña">
            <span *ngIf="confirmPasswordInvalid" class="field-error">
              Las contraseñas no coinciden
            </span>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="cancelChangePassword()" [disabled]="isSavingPassword">
              Cancelar
            </button>
            <button type="submit" class="btn-save" [disabled]="isSavingPassword || passwordForm.invalid">
              {{ isSavingPassword ? 'Guardando...' : 'Cambiar Contraseña' }}
            </button>
          </div>
        </form>
      </div>

      <div *ngIf="!isEditingPassword" class="password-placeholder">
        <p>••••••••</p>
        <span class="last-change">Última actualización: {{ getLastUpdateDisplay() }}</span>
      </div>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="error && !isLoading" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button class="btn-retry" (click)="loadUserProfile()">Reintentar</button>
  </div>
  <!-- Logout bottom (moved from top): styled red button -->
  <div class="profile-logout-container" style="margin-top:1.5rem; text-align:right;">
    <button class="btn-logout" (click)="onLogout()">Cerrar sesión</button>
  </div>
</div>